<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <title>Panel Profesor</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
     <header>
        <div class="header-content">
            <h1>Panel Profesor - SITO</h1>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar">PR</div>
                    <div class="user-details">
                        <div><p id="usuario">Cargando...</p></div>
                        <div><p id="puesto">Profesor</p></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <span>üö™</span>
                    <span class="logout-text">Cerrar Sesi√≥n</span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="card">
            <h2>Mi Informaci√≥n</h2>
            <div class="form-group">
                <label>N√∫mero de empleado</label>
                <input id="profNum" type="text" disabled>
            </div>
            <div class="form-group">
                <label>Usuario</label>
                <input id="profUsua" type="text" disabled>
            </div>
            <div class="form-group">
                <label>Nombre</label>
                <input id="profNombre" type="text" disabled>
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <div class="password-field">
                    <input id="profPass" type="password">
                    <button class="toggle-btn" onclick="togglePass()">üëÅ</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="actualizarPassword()">
                üîê Actualizar Contrase√±a
            </button>
            <div id="resPass"></div>
        </div>

        <div class="card">
            <h2>Mis Grupos</h2>
            <div class="search-section">
                <div class="search-wrapper">
                    <input id="searchInput" placeholder="Buscar grupo o alumno..." oninput="filtrar()">
                    <select id="grupoSelect" onchange="filtrarSelect()">
                        <option value="">-- Seleccionar grupo --</option>
                    </select>
                    <button class="clear-btn" onclick="limpiarBusqueda()">‚ùå</button>
                </div>
            </div>
            <ul id="grupoLista" class="group-list"></ul>
        </div>
    </main>

  <script>
    const API = "http://localhost:4003/api/profesores";
    let token = localStorage.getItem("token");
    let profesor = JSON.parse(localStorage.getItem("profesor") || "{}");
    let passwordPlano = localStorage.getItem("password") || "";
    let grupos = [];

    if (!token) {
      alert("No hay token. Redirigiendo al login...");
      window.location.href = "/login.html";
    }

    verifyToken();

    // Mostrar datos del profesor
    document.getElementById("profNum").value = profesor.numeroEmpleado || "";
    document.getElementById("profNombre").value = profesor.nombre || "";
    document.getElementById("profUsua").value = profesor.usuario || "";
    document.getElementById("profPass").value = passwordPlano;

    // Mostrar/ocultar contrase√±a
    function togglePass() {
      const pass = document.getElementById("profPass");
      pass.type = pass.type === "password" ? "text" : "password";
    }

    // Actualizar contrase√±a
    async function actualizarPassword() {
      const password = document.getElementById("profPass").value.trim();
      if (!password) { alert("‚ö†Ô∏è La contrase√±a no puede estar vac√≠a"); return; }

      const res = await fetch(`${API}/mi-password`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      document.getElementById("resPass").textContent = JSON.stringify(data, null, 2);
      if (data.mensaje) localStorage.setItem("password", password);
    }

    // Cerrar sesi√≥n
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.replace('/login.html');
    }

    async function verifyToken() {
      try {
        console.log('üîç Verificando token...');
        const response = await fetch('http://localhost:3001/api/auth/verify', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Token inv√°lido');
        }

        const userData = await response.json();
        console.log('‚úÖ Token v√°lido para:', userData.username);

      } catch (error) {
        console.error('‚ùå Token inv√°lido:', error);
        alert('Sesi√≥n expirada. Por favor inicia sesi√≥n again.');
        logout();
      }
    }


    // Cargar grupos
    async function cargarGrupos() {
      const res = await fetch(`${API}/mis-grupos`, { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      if (!Array.isArray(data)) { alert("Error cargando grupos."); return; }
      grupos = data;
      renderGrupos();
      llenarSelect();
    }

    // Render grupos y acorde√≥n
    function renderGrupos(lista = grupos, searchTerm = "") {
      const ul = document.getElementById("grupoLista");
      ul.innerHTML = "";

      lista.forEach(g => {
        const li = document.createElement("li");
        li.textContent = `${g.materia} (${g.grupo})`;

        const container = document.createElement("div");
        container.className = "alumnos-container";
        container.style.display = "none";
        container.id = `alumnos-${g._id}`;
        li.appendChild(container);

        // Solo toggle cuando se hace click en el li, no en inputs ni botones dentro
        li.addEventListener("click", async (e) => {
          if (e.target.tagName.toLowerCase() === "input" || e.target.tagName.toLowerCase() === "button") return;
          const div = document.getElementById(`alumnos-${g._id}`);
          if (div.style.display === "none") {
            div.style.display = "block";
            await mostrarAlumnos(g._id, g.materia, g.grupo, div, searchTerm);
          } else {
            div.style.display = "none";
          }
        });

        ul.appendChild(li);

        // Si hay b√∫squeda, desplegar autom√°ticamente si hay coincidencia
        if (searchTerm !== "") {
          const matchGrupo = `${g.materia} (${g.grupo})`.toLowerCase().includes(searchTerm);
          if (matchGrupo) {
            container.style.display = "block";
            mostrarAlumnos(g._id, g.materia, g.grupo, container, searchTerm);
          }
        }
      });
    }

    // Llenar select de grupos
    function llenarSelect() {
      const sel = document.getElementById("grupoSelect");
      sel.innerHTML = `<option value="">-- Seleccionar grupo --</option>`;
      grupos.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g._id;
        opt.textContent = `${g.materia} (${g.grupo})`;
        sel.appendChild(opt);
      });
    }

    // Mostrar alumnos, solo filas que coincidan si searchTerm existe
    async function mostrarAlumnos(grupoId, materia, grupoNombre, container, searchTerm = "") {
      const res = await fetch(`${API}/mis-grupos/${grupoId}/alumnos`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      let alumnos = await res.json();

      let html = `<table>
        <tr><th>Matr√≠cula</th><th>Nombre</th><th>Materia</th><th>Grupo</th><th>Calificaci√≥n</th></tr>`;

      alumnos.forEach(a => {
        const calificacionesDelGrupo = (a.calificaciones || []).filter(c => {
          const grupoObjId = c.grupo?._id || c.grupo;
          return String(grupoObjId) === String(grupoId) && c.materia === materia;
        });
        const calObj = calificacionesDelGrupo.sort((x, y) => new Date(y.fecha) - new Date(x.fecha))[0] || {};

        const match = searchTerm === "" || 
                      a.nombre.toLowerCase().includes(searchTerm) || 
                      a.matricula.includes(searchTerm) || 
                      `${materia} (${grupoNombre})`.toLowerCase().includes(searchTerm);
        if (!match) return;

        html += `<tr>
          <td>${a.matricula}</td>
          <td>${a.nombre}</td>
          <td>${materia}</td>
          <td>${grupoNombre}</td>
          <td>
            <input id="cal-${a.matricula}" placeholder="Calificaci√≥n" value="${calObj.calificacion || ''}">
            <button class="save-btn" onclick="guardarCal('${grupoId}','${a.matricula}','${materia}','${container.id}')">üíæ</button>
          </td>
        </tr>`;
      });

      container.innerHTML = html;
    }

    // Guardar calificaci√≥n
    async function guardarCal(grupoId, matricula, materia, containerId) {
      const calInput = document.getElementById(`cal-${matricula}`);
      const cal = calInput.value.trim();
      if (cal === "") { alert("‚ö†Ô∏è La calificaci√≥n no puede estar vac√≠a"); return; }
      const numCal = Number(cal);
      if (isNaN(numCal) || numCal < 0) { alert("‚ö†Ô∏è Ingresa un n√∫mero v√°lido"); return; }

      const res = await fetch(`${API}/mis-grupos/${grupoId}/calificaciones`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ matricula, materia, calificacion: numCal })
      });

      alert("Guardado: " + JSON.stringify(await res.json()));
      const container = document.getElementById(containerId);
      mostrarAlumnos(grupoId, materia, grupos.find(g => g._id === grupoId)?.grupo, container);
    }

    // Filtrar lista y alumnos
    function filtrar() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      renderGrupos(grupos, q);
    }

    // Filtrar select
    function filtrarSelect() {
      const id = document.getElementById("grupoSelect").value;
      if (!id) renderGrupos();
      else renderGrupos(grupos.filter(g => g._id === id));
    }

    // Limpiar b√∫squeda
    function limpiarBusqueda() {
      document.getElementById("searchInput").value = "";
      document.getElementById("grupoSelect").value = "";
      renderGrupos();
    }

    // Inicializar
    cargarGrupos();
  </script>
  </body>
</html>

