<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Profesor</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1,h2 { color: #2c3e50; }
input, button, select { margin: 5px 0; padding: 6px; }
.card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 8px; }
th { background: #f4f4f4; }
.search-wrapper { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
.search-wrapper input { flex: 1; }
.clear-btn { cursor: pointer; padding: 4px 8px; background: #eee; border: none; border-radius: 50%; }
.group-list { list-style: none; padding: 0; }
.group-list li { padding: 6px; cursor: pointer; border-bottom: 1px solid #ddd; position: relative; }
.group-list li:hover { background: #f9f9f9; }
.save-btn { background: #2ecc71; color: white; border: none; padding: 4px 8px; cursor: pointer; border-radius: 4px; }
.logout-btn { background: #e74c3c; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 6px; float: right; }
.alumnos-container { padding: 5px 0 0 10px; }
</style>
</head>
<body>
<h1>
  Panel Profesor
  <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
</h1>

<div class="card">
<h2>Mi informaci√≥n</h2>
<label>N√∫mero de empleado</label>
<input id="profNum" disabled>
<label>Nombre</label>
<input id="profNombre" disabled>
<label>Contrase√±a</label>
<div style="display:flex; gap:5px;">
<input id="profPass" type="password">
<button onclick="togglePass()">üëÅ</button>
</div>
<button onclick="actualizarPassword()">Actualizar Contrase√±a</button>
<pre id="resPass"></pre>
</div>

<div class="card">
<h2>Mis Grupos</h2>
<div class="search-wrapper">
  <input id="searchInput" placeholder="Buscar grupo o alumno..." oninput="filtrar()">
  <button class="clear-btn" onclick="limpiarBusqueda()">‚ùå</button>
  <select id="grupoSelect" onchange="filtrarSelect()">
    <option value="">-- Seleccionar grupo --</option>
  </select>
</div>
<ul id="grupoLista" class="group-list"></ul>
</div>

<script>
const API = "http://localhost:4002/api/profesores";
let token = localStorage.getItem("token");
let profesor = JSON.parse(localStorage.getItem("profesor") || "{}");
let passwordPlano = localStorage.getItem("password") || "";
let grupos = [];

if (!token || !profesor.numeroEmpleado) {
  alert("No est√°s logueado");
  window.location.href = "login.html";
}

// Mostrar datos del profesor
document.getElementById("profNum").value = profesor.numeroEmpleado || "";
document.getElementById("profNombre").value = profesor.nombre || "";
document.getElementById("profPass").value = passwordPlano;

// Mostrar/ocultar contrase√±a
function togglePass() {
  const pass = document.getElementById("profPass");
  pass.type = pass.type === "password" ? "text" : "password";
}

// Actualizar contrase√±a
async function actualizarPassword() {
  const password = document.getElementById("profPass").value.trim();
  if (!password) { alert("‚ö†Ô∏è La contrase√±a no puede estar vac√≠a"); return; }

  const res = await fetch(`${API}/mi-password`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
    body: JSON.stringify({ password })
  });
  const data = await res.json();
  document.getElementById("resPass").textContent = JSON.stringify(data, null, 2);
  if (data.mensaje) localStorage.setItem("password", password);
}

// Cerrar sesi√≥n
function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("profesor");
  localStorage.removeItem("password");
  window.location.href = "login.html";
}

// Cargar grupos
async function cargarGrupos() {
  const res = await fetch(`${API}/mis-grupos`, { headers: { Authorization: `Bearer ${token}` } });
  const data = await res.json();
  if (!Array.isArray(data)) { alert("Error cargando grupos."); return; }
  grupos = data;
  renderGrupos();
  llenarSelect();
}

// Render grupos y acorde√≥n
function renderGrupos(lista = grupos, searchTerm = "") {
  const ul = document.getElementById("grupoLista");
  ul.innerHTML = "";

  lista.forEach(g => {
    const li = document.createElement("li");
    li.textContent = `${g.materia} (${g.grupo})`;

    const container = document.createElement("div");
    container.className = "alumnos-container";
    container.style.display = "none";
    container.id = `alumnos-${g._id}`;
    li.appendChild(container);

    // Solo toggle cuando se hace click en el li, no en inputs ni botones dentro
    li.addEventListener("click", async (e) => {
      if (e.target.tagName.toLowerCase() === "input" || e.target.tagName.toLowerCase() === "button") return;
      const div = document.getElementById(`alumnos-${g._id}`);
      if (div.style.display === "none") {
        div.style.display = "block";
        await mostrarAlumnos(g._id, g.materia, g.grupo, div, searchTerm);
      } else {
        div.style.display = "none";
      }
    });

    ul.appendChild(li);

    // Si hay b√∫squeda, desplegar autom√°ticamente si hay coincidencia
    if (searchTerm !== "") {
      const matchGrupo = `${g.materia} (${g.grupo})`.toLowerCase().includes(searchTerm);
      if (matchGrupo) {
        container.style.display = "block";
        mostrarAlumnos(g._id, g.materia, g.grupo, container, searchTerm);
      }
    }
  });
}

// Llenar select de grupos
function llenarSelect() {
  const sel = document.getElementById("grupoSelect");
  sel.innerHTML = `<option value="">-- Seleccionar grupo --</option>`;
  grupos.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g._id;
    opt.textContent = `${g.materia} (${g.grupo})`;
    sel.appendChild(opt);
  });
}

// Mostrar alumnos, solo filas que coincidan si searchTerm existe
async function mostrarAlumnos(grupoId, materia, grupoNombre, container, searchTerm = "") {
  const res = await fetch(`${API}/mis-grupos/${grupoId}/alumnos`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  let alumnos = await res.json();

  let html = `<table>
    <tr><th>Matr√≠cula</th><th>Nombre</th><th>Materia</th><th>Grupo</th><th>Calificaci√≥n</th></tr>`;

  alumnos.forEach(a => {
    const calificacionesDelGrupo = (a.calificaciones || []).filter(c => {
      const grupoObjId = c.grupo?._id || c.grupo;
      return String(grupoObjId) === String(grupoId) && c.materia === materia;
    });
    const calObj = calificacionesDelGrupo.sort((x, y) => new Date(y.fecha) - new Date(x.fecha))[0] || {};

    const match = searchTerm === "" || 
                  a.nombre.toLowerCase().includes(searchTerm) || 
                  a.matricula.includes(searchTerm) || 
                  `${materia} (${grupoNombre})`.toLowerCase().includes(searchTerm);
    if (!match) return;

    html += `<tr>
      <td>${a.matricula}</td>
      <td>${a.nombre}</td>
      <td>${materia}</td>
      <td>${grupoNombre}</td>
      <td>
        <input id="cal-${a.matricula}" placeholder="Calificaci√≥n" value="${calObj.calificacion || ''}">
        <button class="save-btn" onclick="guardarCal('${grupoId}','${a.matricula}','${materia}','${container.id}')">üíæ</button>
      </td>
    </tr>`;
  });

  container.innerHTML = html;
}

// Guardar calificaci√≥n
async function guardarCal(grupoId, matricula, materia, containerId) {
  const calInput = document.getElementById(`cal-${matricula}`);
  const cal = calInput.value.trim();
  if (cal === "") { alert("‚ö†Ô∏è La calificaci√≥n no puede estar vac√≠a"); return; }
  const numCal = Number(cal);
  if (isNaN(numCal) || numCal < 0) { alert("‚ö†Ô∏è Ingresa un n√∫mero v√°lido"); return; }

  const res = await fetch(`${API}/mis-grupos/${grupoId}/calificaciones`, {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
    body: JSON.stringify({ matricula, materia, calificacion: numCal })
  });

  alert("Guardado: " + JSON.stringify(await res.json()));
  const container = document.getElementById(containerId);
  mostrarAlumnos(grupoId, materia, grupos.find(g => g._id === grupoId)?.grupo, container);
}

// Filtrar lista y alumnos
function filtrar() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  renderGrupos(grupos, q);
}

// Filtrar select
function filtrarSelect() {
  const id = document.getElementById("grupoSelect").value;
  if (!id) renderGrupos();
  else renderGrupos(grupos.filter(g => g._id === id));
}

// Limpiar b√∫squeda
function limpiarBusqueda() {
  document.getElementById("searchInput").value = "";
  document.getElementById("grupoSelect").value = "";
  renderGrupos();
}

// Inicializar
cargarGrupos();
</script>
</body>
</html>
