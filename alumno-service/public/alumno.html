<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Portal del Alumno</title>
    <link rel="stylesheet" href="alumno.css">
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo"><h1>Portal del Alumno</h1></div>
        <div class="user-info">
            <div class="user-avatar">AL</div>
            <div>
                <div id="alumnoNombre" style="font-weight: 500;">Alumno Nombre</div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Estudiante</div>
            </div>
            <!-- üî¥ Bot√≥n de Cerrar Sesi√≥n -->
            <button id="logoutBtn" style="margin-left: 1rem; padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>
</header>

<nav>
    <div class="nav-content">
        <button class="nav-btn active" onclick="showSection('info', event)">Mi Informaci√≥n</button>
        <button class="nav-btn" onclick="showSection('grupos', event)">Mis Calificaciones</button>
        <button class="nav-btn" onclick="showSection('cambiarContrasena', event)">Cambiar Contrase√±a</button>
    </div>
</nav>

<main>
    <!-- Mi Informaci√≥n -->
    <section id="info" class="section active">
        <h2>Mi Informaci√≥n</h2>
        <div class="student-card show">
            <div class="student-info">
                <div class="info-item"><div class="info-label">Nombre:</div><div class="info-value" id="idNombre"></div></div>
                <div class="info-item"><div class="info-label">Matr√≠cula:</div><div class="info-value" id="idMatricula"></div></div>
                <div class="info-item"><div class="info-label">Usuario:</div><div class="info-value" id="idUsuario"></div></div>
                <div class="info-item"><div class="info-label">Carrera:</div><div class="info-value" id="idCarrera"></div></div>
            </div>
        </div>
    </section>

    <!-- Mis Grupos y Calificaciones -->
    <section id="grupos" class="section">
      <h2>Mis Grupos</h2>
      <div id="groupsContainer"></div>

      <table id="tablaCalificaciones" class="tablaCalificaciones">
        <thead>
          <tr>
            <th>Materia</th>
            <th>Profesor</th>
            <th>Calificaci√≥n</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Cambiar Contrase√±a -->
    <section id="cambiarContrasena" class="section">
        <h2>Cambiar Contrase√±a</h2>
        <form id="formContrasena">
            <div class="form-group">
                <label for="contrasenaActual">Contrase√±a Actual:</label>
                <input type="password" id="contrasenaActual" required>
            </div>
            <div class="form-group">
                <label for="nuevaContrasena">Nueva Contrase√±a:</label>
                <input type="password" id="nuevaContrasena" required>
            </div>
            <div style="margin-top: 1rem;">
                <button type="submit" class="btn btn-primary">Actualizar Contrase√±a</button>
            </div>
        </form>
    </section>
</main>


<script>
        const token = localStorage.getItem('token');
        console.log('Token en localStorage:', token);
        
        if (!token) {
            alert('No hay token. Redirigiendo al login...');
            window.location.replace('/login.html');
        }

        // Verificar token al cargar la p√°gina
        verifyToken();

        async function verifyToken() {
            try {
                console.log('üîç Verificando token...');
                const response = await fetch('http://localhost:3001/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Token inv√°lido');
                }

                const userData = await response.json();
                console.log('‚úÖ Token v√°lido para:', userData.username);
                
            } catch (error) {
                console.error('‚ùå Token inv√°lido:', error);
                alert('Sesi√≥n expirada. Por favor inicia sesi√≥n again.');
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.replace('/login.html');
        }

        // Conectar bot√≥n con logout
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Debug: Mostrar info del token
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('üîê Token info:', {
                    username: payload.username,
                    role: payload.role,
                    exp: new Date(payload.exp * 1000)
                });
            } catch (e) {
                console.log('‚ùå No se pudo decodificar el token');
            }
        }
    </script>
    <script src="navegacion.js"></script>
    <script src="login.js"></script>
</body>
</html>
