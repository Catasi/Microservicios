<!DOCTYPE html>
<html>
<head>
    <title>RH Dashboard - SITO</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <header>
            <h1>Recursos Humanos</h1>
            <button onclick="logout()">Cerrar Sesi√≥n</button>
        </header>

        <div class="content">
            <h2>Registrar Nuevo Profesor</h2>
            <form id="professorForm">
                <input type="text" id="employeeNumber" placeholder="N√∫mero de empleado" required>
                <input type="text" id="name" placeholder="Nombre completo" required>
                <select id="position" name="position" required>
                    <option value="">Selecciona un puesto</option>
                    <option value="profesor">Profesor</option>
                    <option value="rh">RH</option>
                    <option value="servicios_escolares">Servicios Escolares</option>
                </select>
                <input type="text" id="username" placeholder="Usuario" required>
                <input type="password" id="password" placeholder="Contrase√±a" required>
                <button type="submit">Registrar Profesor</button>
            </form>

            <h2>Lista de Profesores</h2>
            <div id="professorsList"></div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        console.log('Token en localStorage:', token);
        
        if (!token) {
            alert('No hay token. Redirigiendo al login...');
            window.location.replace('/login.html');
        }

        // Verificar token al cargar la p√°gina
        verifyToken();

        // Cargar profesores al iniciar
        loadProfessors();

        document.getElementById('professorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const professorData = {
                employeeNumber: document.getElementById('employeeNumber').value,
                name: document.getElementById('name').value,
                position: document.getElementById('position').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            console.log('üì§ Enviando datos:', professorData);

            try {
                const response = await fetch('http://localhost:3002/api/professors/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(professorData)
                });

                console.log('üì• Status de respuesta:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Success:', result);
                    alert('Profesor registrado exitosamente');
                    // Limpiar formulario
                    document.getElementById('professorForm').reset();
                    loadProfessors();
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    console.error('‚ùå Error:', errorData);
                    alert('Error al registrar profesor: ' + (errorData.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('üî• Error de conexi√≥n:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        });

        async function loadProfessors() {
            try {
                console.log('üîÑ Cargando profesores...');
                const response = await fetch('http://localhost:3002/api/professors', {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üìä Status de carga:', response.status);
                
                if (response.ok) {
                    const professors = await response.json();
                    console.log('üë• Profesores cargados:', professors);
                    
                    const list = document.getElementById('professorsList');
                    list.innerHTML = professors.map(prof => `
                        <div class="professor-card">
                            <h3>${prof.name}</h3>
                            <p>N√∫mero: ${prof.employeeNumber}</p>
                            <p>Puesto: ${prof.position}</p>
                            <p>Estado: ${prof.active ? 'Activo' : 'Inactivo'}</p>
                        </div>
                    `).join('');
                } else {
                    console.error('‚ùå Error cargando profesores:', await response.text());
                }
            } catch (error) {
                console.error('üî• Error loading professors:', error);
            }
        }

        async function verifyToken() {
            try {
                console.log('üîç Verificando token...');
                const response = await fetch('http://localhost:3001/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Token inv√°lido');
                }

                const userData = await response.json();
                console.log('‚úÖ Token v√°lido para:', userData.username);
                
            } catch (error) {
                console.error('‚ùå Token inv√°lido:', error);
                alert('Sesi√≥n expirada. Por favor inicia sesi√≥n again.');
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.replace('/login.html');
        }

        // Debug: Mostrar info del token
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('üîê Token info:', {
                    username: payload.username,
                    role: payload.role,
                    exp: new Date(payload.exp * 1000)
                });
            } catch (e) {
                console.log('‚ùå No se pudo decodificar el token');
            }
        }
    </script>
</body>
</html>